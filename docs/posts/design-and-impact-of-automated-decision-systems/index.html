<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Vikram Vasan">
<meta name="dcterms.date" content="2025-02-24">
<meta name="description" content="Blog Post 2">

<title>Design and Impact of Automated Decision Systems â€“ Vikram Vasan CSCI 0451 Blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-6de787833effe4777a6777a5e05fb578.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>

      .quarto-title-block .quarto-title-banner h1,
      .quarto-title-block .quarto-title-banner h2,
      .quarto-title-block .quarto-title-banner h3,
      .quarto-title-block .quarto-title-banner h4,
      .quarto-title-block .quarto-title-banner h5,
      .quarto-title-block .quarto-title-banner h6
      {
        color: white;
      }

      .quarto-title-block .quarto-title-banner {
        color: white;
background-image: url(../../img/landscape.png);
background-size: cover;
      }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Vikram Vasan CSCI 0451 Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Design and Impact of Automated Decision Systems</h1>
                  <div>
        <div class="description">
          Blog Post 2
        </div>
      </div>
                </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Vikram Vasan </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 24, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="abstract" class="level1">
<h1>Abstract</h1>
<p>In this blog post, we will be exploring bank loan data, specifically inquiring about the ability to predict loan success based on borrower characteristics. The data includes information about the borrower, loan amount, loan status, and other relevant information. Loan status is the target variable, where 1 indicates a default and 0 means the loan was repaid. We will test different combinations of features with a Logistic Regression model to discover the most predictive indicators of loan success. We will then discuss the results including an investigation of how different groups would be affected if the model were to be implemented.</p>
</section>
<section id="explore-the-data" class="level1">
<h1>Explore the Data</h1>
<section id="summary-statistics" class="level2">
<h2 class="anchored" data-anchor-id="summary-statistics">Summary Statistics</h2>
<p>The first task is to explore the data, and understand the distribution of the features as they relate to the target variable. We will start by grouping the data by the target variable and calculating the mean of each feature. This will give us an idea of how the features differ between the two groups.</p>
<div id="cell-4" class="cell" data-execution_count="238">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>df_stats <span class="op">=</span> df_train.copy()</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>df_stats[<span class="st">"cb_person_default_on_file"</span>] <span class="op">=</span> (df_stats[<span class="st">"cb_person_default_on_file"</span>] <span class="op">==</span> <span class="st">"Y"</span>).astype(<span class="bu">int</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>df_stats[<span class="st">"loan_status"</span>] <span class="op">=</span> df_stats[<span class="st">"loan_status"</span>].<span class="bu">map</span>({<span class="dv">1</span>: <span class="st">"Default"</span>, <span class="dv">0</span>: <span class="st">"Repaid"</span>})</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>summary_table <span class="op">=</span> df_stats.groupby(<span class="st">"loan_status"</span>).mean(numeric_only<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>home_ownership_percentages <span class="op">=</span> df_stats.groupby(<span class="st">"loan_status"</span>)[<span class="st">"person_home_ownership"</span>].value_counts(normalize<span class="op">=</span><span class="va">True</span>).unstack(fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>loan_intent_percentages <span class="op">=</span> df_stats.groupby(<span class="st">"loan_status"</span>)[<span class="st">"loan_intent"</span>].value_counts(normalize<span class="op">=</span><span class="va">True</span>).unstack(fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>final_summary <span class="op">=</span> summary_table.join(home_ownership_percentages).join(loan_intent_percentages)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>final_summary.reset_index(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>final_summary.columns <span class="op">=</span> final_summary.columns.<span class="bu">str</span>.replace(<span class="st">'_'</span>, <span class="st">' '</span>).<span class="bu">str</span>.title()</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>final_summary <span class="op">=</span> final_summary.<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>display(final_summary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Loan Status</th>
<th data-quarto-table-cell-role="th">Person Age</th>
<th data-quarto-table-cell-role="th">Person Income</th>
<th data-quarto-table-cell-role="th">Person Emp Length</th>
<th data-quarto-table-cell-role="th">Loan Amnt</th>
<th data-quarto-table-cell-role="th">Loan Int Rate</th>
<th data-quarto-table-cell-role="th">Loan Percent Income</th>
<th data-quarto-table-cell-role="th">Cb Person Default On File</th>
<th data-quarto-table-cell-role="th">Cb Person Cred Hist Length</th>
<th data-quarto-table-cell-role="th">Mortgage</th>
<th data-quarto-table-cell-role="th">Other</th>
<th data-quarto-table-cell-role="th">Own</th>
<th data-quarto-table-cell-role="th">Rent</th>
<th data-quarto-table-cell-role="th">Debtconsolidation</th>
<th data-quarto-table-cell-role="th">Education</th>
<th data-quarto-table-cell-role="th">Homeimprovement</th>
<th data-quarto-table-cell-role="th">Medical</th>
<th data-quarto-table-cell-role="th">Personal</th>
<th data-quarto-table-cell-role="th">Venture</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Default</td>
<td>27.439</td>
<td>48883.177</td>
<td>4.159</td>
<td>10769.053</td>
<td>0.131</td>
<td>0.246</td>
<td>0.303</td>
<td>5.652</td>
<td>0.236</td>
<td>0.005</td>
<td>0.030</td>
<td>0.729</td>
<td>0.212</td>
<td>0.157</td>
<td>0.135</td>
<td>0.224</td>
<td>0.151</td>
<td>0.121</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Repaid</td>
<td>27.817</td>
<td>70727.745</td>
<td>4.954</td>
<td>9235.881</td>
<td>0.104</td>
<td>0.149</td>
<td>0.140</td>
<td>5.834</td>
<td>0.460</td>
<td>0.003</td>
<td>0.094</td>
<td>0.443</td>
<td>0.146</td>
<td>0.208</td>
<td>0.105</td>
<td>0.175</td>
<td>0.174</td>
<td>0.193</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Looking solely at the means, we see some interesting differences between defaulted and repaid loans. For example, as one would expect, defaulted loans have a higher average loan percent of income and interest rate. This makes sense because if a loan is a larger percent of ones income, it is harder to pay off. Similarly, a higher interest rate would make it more difficult to pay off the loan. It is also interesting to see that 73% of defaulted loans are taken out by individuals who rent their homes, compared to only 44% for repaid loans. This could be due to the fact that renters have less disposable income than homeowners. Finally, the loan amount averages is curious because the average loan amount doesnâ€™t differ that much between groups. One would expect that defaulted loans would have a higher average loan amount, but this is only slightly the case.</p>
</section>
<section id="visualizations" class="level2">
<h2 class="anchored" data-anchor-id="visualizations">Visualizations</h2>
<p>To get a better idea of the characteristics of the data, we will continue by plotting some of the more interesting variables. We will scatter two continuous variables against each other, and color the points by the outcome of the loan. This will give us more of an idea of the relationships than the mean can give us. We will also calculate a line of best fit for each pairing to get a sense for whether the relationship is particularly predictive.</p>
<div id="cell-6" class="cell" data-execution_count="239">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>df_vis <span class="op">=</span> df_train.copy()</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>df_vis[<span class="st">"loan_status"</span>] <span class="op">=</span> df_vis[<span class="st">"loan_status"</span>].<span class="bu">map</span>({<span class="dv">1</span>: <span class="st">"Default"</span>, <span class="dv">0</span>: <span class="st">"Repaid"</span>})</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>df_vis.columns <span class="op">=</span> df_vis.columns.<span class="bu">str</span>.replace(<span class="st">'_'</span>, <span class="st">' '</span>).<span class="bu">str</span>.title()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">17</span>, <span class="fl">3.5</span>))</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># define colors for each loan_status</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>palette <span class="op">=</span> [<span class="st">"blue"</span>, <span class="st">"#C76E00"</span>]</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>p1 <span class="op">=</span> sns.scatterplot(df_vis, x<span class="op">=</span><span class="st">"Person Emp Length"</span>, y<span class="op">=</span><span class="st">"Person Income"</span>, hue<span class="op">=</span><span class="st">"Loan Status"</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>])</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_xlim(<span class="dv">0</span>, <span class="dv">42</span>)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_ylim(<span class="dv">0</span>, <span class="dv">1000000</span>)  <span class="co"># To remove outliers</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, status <span class="kw">in</span> <span class="bu">enumerate</span>(df_vis[<span class="st">"Loan Status"</span>].unique()):</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> df_vis[df_vis[<span class="st">"Loan Status"</span>] <span class="op">==</span> status]</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    sns.regplot(data<span class="op">=</span>subset, x<span class="op">=</span><span class="st">"Person Emp Length"</span>, y<span class="op">=</span><span class="st">"Person Income"</span>, scatter<span class="op">=</span><span class="va">False</span>, ci<span class="op">=</span><span class="va">None</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>], color<span class="op">=</span>palette[i])</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>p2 <span class="op">=</span> sns.scatterplot(df_vis, x<span class="op">=</span><span class="st">"Loan Amnt"</span>, y<span class="op">=</span><span class="st">"Loan Percent Income"</span>, hue<span class="op">=</span><span class="st">"Loan Status"</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>])</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, status <span class="kw">in</span> <span class="bu">enumerate</span>(df_vis[<span class="st">"Loan Status"</span>].unique()):</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> df_vis[df_vis[<span class="st">"Loan Status"</span>] <span class="op">==</span> status]</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    sns.regplot(data<span class="op">=</span>subset, x<span class="op">=</span><span class="st">"Loan Amnt"</span>, y<span class="op">=</span><span class="st">"Loan Percent Income"</span>, scatter<span class="op">=</span><span class="va">False</span>, ci<span class="op">=</span><span class="va">None</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>], color<span class="op">=</span>palette[i])</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>p3 <span class="op">=</span> sns.scatterplot(df_vis, x<span class="op">=</span><span class="st">"Cb Person Cred Hist Length"</span>, y<span class="op">=</span><span class="st">"Loan Int Rate"</span>, hue<span class="op">=</span><span class="st">"Loan Status"</span>, ax<span class="op">=</span>ax[<span class="dv">2</span>])</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, status <span class="kw">in</span> <span class="bu">enumerate</span>(df_vis[<span class="st">"Loan Status"</span>].unique()):</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> df_vis[df_vis[<span class="st">"Loan Status"</span>] <span class="op">==</span> status]</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    sns.regplot(data<span class="op">=</span>subset, x<span class="op">=</span><span class="st">"Cb Person Cred Hist Length"</span>, y<span class="op">=</span><span class="st">"Loan Int Rate"</span>, scatter<span class="op">=</span><span class="va">False</span>, ci<span class="op">=</span><span class="va">None</span>, ax<span class="op">=</span>ax[<span class="dv">2</span>], color<span class="op">=</span>palette[i])</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The first plot of income vs employment length is interesting because it is contrary to what we observed in the summary statistics. Both income and employment length appear to have very little between them when it comes to loan status. The lines of best fit for each group almost overlap indicating that the difference between groups is marginal. This is surprising because the summary statistics showed that the average income of borrowers who repay their loans is over $20,000 higher than those who default. This is a case where means can be deceiving because a lot of that difference can be accounted for by a few outliers with very high incomes. The lines of best fit recognize this and show that the relationship is not as strong as the mean would suggest.</p>
<p>The second plot of loan amount vs loan percent of income is more in line with what we would expect. The line of best fit for defaulted loans is steeper and higher than that of repaid loans, indicating that the loan amount is more predictive of loan status than income. This makes sense because the relative size of a loan to oneâ€™s income is a better indicator of whether they can pay it back than income alone. Finally, the third plot shows the interest rate against the credit history length. The lines of best fit are very separated indicating that interest rate has a significant impact on ability to repay as we anticipated.</p>
</section>
</section>
<section id="build-a-model" class="level1">
<h1>Build a Model</h1>
<section id="data-preprocessing" class="level2">
<h2 class="anchored" data-anchor-id="data-preprocessing">Data Preprocessing</h2>
<p>The next step is to train a model on the data. The first thing we need to do, in order to accomplish this, is to preprocess the data. This involves removing the target variable from the feature set and using one-hot encoding to binarize the categorical variables.</p>
<div id="cell-8" class="cell" data-execution_count="240">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>le <span class="op">=</span> LabelEncoder()</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>le.fit(df_train[<span class="st">"loan_status"</span>])</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_data(df):</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  df <span class="op">=</span> df.dropna()</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  y <span class="op">=</span> le.transform(df[<span class="st">"loan_status"</span>])</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  x <span class="op">=</span> df.drop([<span class="st">"loan_status"</span>, <span class="st">"loan_grade"</span>], axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  x <span class="op">=</span> pd.get_dummies(x)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> x, y</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>X_train, y_train <span class="op">=</span> prepare_data(df_train)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> X_train.reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>X_train.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="240">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">person_age</th>
<th data-quarto-table-cell-role="th">person_income</th>
<th data-quarto-table-cell-role="th">person_emp_length</th>
<th data-quarto-table-cell-role="th">loan_amnt</th>
<th data-quarto-table-cell-role="th">loan_int_rate</th>
<th data-quarto-table-cell-role="th">loan_percent_income</th>
<th data-quarto-table-cell-role="th">cb_person_cred_hist_length</th>
<th data-quarto-table-cell-role="th">person_home_ownership_MORTGAGE</th>
<th data-quarto-table-cell-role="th">person_home_ownership_OTHER</th>
<th data-quarto-table-cell-role="th">person_home_ownership_OWN</th>
<th data-quarto-table-cell-role="th">person_home_ownership_RENT</th>
<th data-quarto-table-cell-role="th">loan_intent_DEBTCONSOLIDATION</th>
<th data-quarto-table-cell-role="th">loan_intent_EDUCATION</th>
<th data-quarto-table-cell-role="th">loan_intent_HOMEIMPROVEMENT</th>
<th data-quarto-table-cell-role="th">loan_intent_MEDICAL</th>
<th data-quarto-table-cell-role="th">loan_intent_PERSONAL</th>
<th data-quarto-table-cell-role="th">loan_intent_VENTURE</th>
<th data-quarto-table-cell-role="th">cb_person_default_on_file_N</th>
<th data-quarto-table-cell-role="th">cb_person_default_on_file_Y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>27</td>
<td>98000</td>
<td>3.0</td>
<td>11750</td>
<td>0.1347</td>
<td>0.12</td>
<td>6</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>22</td>
<td>36996</td>
<td>5.0</td>
<td>10000</td>
<td>0.0751</td>
<td>0.27</td>
<td>4</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>24</td>
<td>26000</td>
<td>2.0</td>
<td>1325</td>
<td>0.1287</td>
<td>0.05</td>
<td>4</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>29</td>
<td>53004</td>
<td>2.0</td>
<td>15000</td>
<td>0.0963</td>
<td>0.28</td>
<td>10</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>21</td>
<td>21700</td>
<td>2.0</td>
<td>5500</td>
<td>0.1491</td>
<td>0.25</td>
<td>2</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="feature-selection" class="level2">
<h2 class="anchored" data-anchor-id="feature-selection">Feature Selection</h2>
<p>With the data processed, we now need to determine which features to include in the model. To do this we will perform an exhaustive search of every combination of 3 features and use cross-validation scores to compare them. The following code will perform these tests by training a logistic regression model on each combination of features and calculating the cross-validation score. The best combination of features will be the one with the highest cross-validation score.</p>
<div id="cell-10" class="cell" data-execution_count="241">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>attributes <span class="op">=</span> X_train.columns</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>combs <span class="op">=</span> <span class="bu">list</span>(combinations(attributes, <span class="dv">3</span>))</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>tests <span class="op">=</span> []</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cols <span class="kw">in</span> combs:</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    LR <span class="op">=</span> LogisticRegression()</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    LR.fit(X_train[<span class="bu">list</span>(cols)], y_train)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    LR.score(X_train[<span class="bu">list</span>(cols)], y_train)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    cv_scores <span class="op">=</span> cross_val_score(LR, X_train[<span class="bu">list</span>(cols)], y_train, cv <span class="op">=</span> <span class="dv">5</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    tests.append((<span class="bu">list</span>(cols), cv_scores.mean()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To find the best combination we will sort by cross-validation score and display the top 5 combinations.</p>
<div id="cell-12" class="cell" data-execution_count="242">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>df_results <span class="op">=</span> pd.DataFrame(tests, columns<span class="op">=</span>[<span class="st">"Columns"</span>, <span class="st">"Cross-Validation Score"</span>])</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>df_results[<span class="st">"Columns"</span>] <span class="op">=</span> df_results[<span class="st">"Columns"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="st">", "</span>.join(x))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.max_colwidth"</span>, <span class="va">None</span>)  <span class="co"># no truncation of column text</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>df_results <span class="op">=</span> df_results.sort_values(by<span class="op">=</span><span class="st">"Cross-Validation Score"</span>, ascending<span class="op">=</span><span class="va">False</span>) <span class="co"># sort by cross-val score</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>df_results.reset_index(drop<span class="op">=</span><span class="va">True</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>df_results.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="242">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Columns</th>
<th data-quarto-table-cell-role="th">Cross-Validation Score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>loan_percent_income, person_home_ownership_RENT, loan_intent_HOMEIMPROVEMENT</td>
<td>0.849521</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>loan_percent_income, person_home_ownership_RENT, loan_intent_DEBTCONSOLIDATION</td>
<td>0.849260</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>loan_percent_income, person_home_ownership_OTHER, person_home_ownership_RENT</td>
<td>0.849216</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>loan_percent_income, person_home_ownership_MORTGAGE, person_home_ownership_OWN</td>
<td>0.848736</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>loan_percent_income, person_home_ownership_RENT, loan_intent_MEDICAL</td>
<td>0.848430</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>As the above table shows, the combination of <strong>loan percent of income</strong>, <strong>person home ownership: rent</strong>, and <strong>loan intent: home improvement</strong> performs the best with a cross-validation score of 0.8495. This makes sense with our initial exploration as we recognized the big difference between groups in loan percent of income and home ownership status.</p>
<p>With the best combination of features determined, we can now train the model on the entire dataset and evaluate its performance.</p>
<div id="cell-14" class="cell" data-execution_count="243">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> df_results[<span class="st">"Columns"</span>].iloc[<span class="dv">0</span>].split(<span class="st">", "</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>LR <span class="op">=</span> LogisticRegression()</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>LR.fit(X_train[cols], y_train)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>LR_train_score <span class="op">=</span> LR.score(X_train[cols], y_train)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Training Score: </span><span class="sc">{</span>LR_train_score<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>w <span class="op">=</span> LR.coef_[<span class="dv">0</span>]</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Weight Vector (w): </span><span class="sc">{</span>w<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Training Score: 0.8493473610686689
Weight Vector (w): [8.14642112 1.19649321 0.49192603]</code></pre>
</div>
</div>
<p>Above we see the training score which matches the cross-validation score, as expected, as well as the weight vector which we will use in the next section to find a threshold.</p>
</section>
</section>
<section id="find-a-threshold" class="level1">
<h1>Find a Threshold</h1>
<p>The next step is to determine a threshold past which to classify a loan as a predicted default. We will do this by computing a score for each loan using the dot product of the features and the learned weight vector. Now, with a score for every loan, we can test thresholds up to the maximum score and calculate the expected benefit for the bank at each threshold. This benefit depends on the loan amount and interest rate for each loan so we will have to add these to the computation.</p>
<p>The two outcomes we are interested in are the true negatives and the false negatives. This is the number of loans that were correctly predicted to be repaid and the number that were predicted to repay but instead defaulted. The predicted defaults are ignored because the bank would not have offered a loan so there would be no benefit. On the true negatives, the bank benefits from the interest rate on the loan but on the false negatives, the bank loses the loan amount. The benefit is calculated by summing the benefit from the true negatives and subtracting the benefit from the false negatives.</p>
<div id="cell-16" class="cell" data-execution_count="246">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> linear_score(X, w):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> X<span class="op">@</span>w</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>best_benefit <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>best_threshold <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> linear_score(X_train[cols], w)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize <span class="op">=</span> (<span class="dv">6</span>, <span class="dv">4</span>))</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>loan_amnt <span class="op">=</span> X_train[<span class="st">"loan_amnt"</span>].values</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>loan_int_rate <span class="op">=</span> X_train[<span class="st">"loan_int_rate"</span>].values</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> t <span class="kw">in</span> np.linspace(<span class="dv">0</span>, <span class="bu">max</span>(s), <span class="dv">101</span>):</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> s <span class="op">&gt;=</span> t</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    benefit_good <span class="op">=</span> (loan_amnt <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> <span class="fl">0.25</span> <span class="op">*</span> loan_int_rate) <span class="op">**</span> <span class="dv">10</span>) <span class="op">-</span> loan_amnt</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    benefit_bad <span class="op">=</span> (loan_amnt <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> <span class="fl">0.25</span> <span class="op">*</span> loan_int_rate) <span class="op">**</span> <span class="dv">3</span>) <span class="op">-</span> (<span class="fl">1.7</span> <span class="op">*</span> loan_amnt)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    benefit <span class="op">=</span> np.where((<span class="op">~</span>y_pred) <span class="op">&amp;</span> (y_train <span class="op">==</span> <span class="dv">0</span>), benefit_good, <span class="dv">0</span>) <span class="op">+</span> np.where((<span class="op">~</span>y_pred) <span class="op">&amp;</span> (y_train <span class="op">==</span> <span class="dv">1</span>), benefit_bad, <span class="dv">0</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    benefit <span class="op">=</span> benefit.mean()</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    ax.scatter(t, benefit, color <span class="op">=</span> <span class="st">"steelblue"</span>, s <span class="op">=</span> <span class="dv">10</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> benefit <span class="op">&gt;</span> best_benefit: </span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>        best_benefit <span class="op">=</span> benefit</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>        best_threshold <span class="op">=</span> t</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>ax.axvline(best_threshold, linestyle <span class="op">=</span> <span class="st">"--"</span>, color <span class="op">=</span> <span class="st">"grey"</span>, zorder <span class="op">=</span> <span class="op">-</span><span class="dv">10</span>)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>labs <span class="op">=</span> ax.<span class="bu">set</span>(xlabel <span class="op">=</span> <span class="vs">r"Threshold"</span>, ylabel <span class="op">=</span> <span class="st">"Profit per Borrower"</span>, title <span class="op">=</span> <span class="ss">f"Best benefit $</span><span class="sc">{</span>best_benefit<span class="sc">:.2f}</span><span class="ss"> at best threshold t = </span><span class="sc">{</span>best_threshold<span class="sc">:.3f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As the above plot demonstrates, our model is most beneficial for the bank when the threshold is <strong>3.66</strong>, where the benefit per person is maximizes at $1452.43. This means that the bank would benefit the most by only offering loans to individuals with a score above 3.66.</p>
</section>
<section id="evaluate-from-the-banks-perspective" class="level1">
<h1>Evaluate from the Bankâ€™s Perspective</h1>
<p>We can now use this threshold to predict the outcome of future loans, from the test set, and calculate the benefit.</p>
<div id="cell-20" class="cell" data-execution_count="259">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> best_threshold</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># compute the scores</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> linear_score(X_test[cols], w)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> s <span class="op">&gt;=</span> t</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>loan_amnt <span class="op">=</span> X_test[<span class="st">"loan_amnt"</span>].values</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>loan_int_rate <span class="op">=</span> X_test[<span class="st">"loan_int_rate"</span>].values</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>benefit_good <span class="op">=</span> (loan_amnt <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> <span class="fl">0.25</span> <span class="op">*</span> loan_int_rate) <span class="op">**</span> <span class="dv">10</span>) <span class="op">-</span> loan_amnt</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>benefit_bad <span class="op">=</span> (loan_amnt <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> <span class="fl">0.25</span> <span class="op">*</span> loan_int_rate) <span class="op">**</span> <span class="dv">3</span>) <span class="op">-</span> (<span class="fl">1.7</span> <span class="op">*</span> loan_amnt)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>benefit <span class="op">=</span> np.where((<span class="op">~</span>preds) <span class="op">&amp;</span> (y_test <span class="op">==</span> <span class="dv">0</span>), benefit_good, <span class="dv">0</span>) <span class="op">+</span> np.where((<span class="op">~</span>preds) <span class="op">&amp;</span> (y_test <span class="op">==</span> <span class="dv">1</span>), benefit_bad, <span class="dv">0</span>)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Expected Profit per Borrower: $</span><span class="sc">{</span>benefit<span class="sc">.</span>mean()<span class="sc">.</span><span class="bu">round</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Expected Profit per Borrower: $1400.17</code></pre>
</div>
</div>
<p>As we see, the expected profit per borrower with this threshold is <strong>$1400.17</strong> which is in line with the expected benefit we calculated with the training data. This means that the model is generalizing well and would be beneficial for the bank to implement.</p>
</section>
<section id="evaluate-from-the-borrowers-perspective" class="level1">
<h1>Evaluate from the Borrowerâ€™s Perspective</h1>
<p>We next want to consider how the implementation of this model would affect borrowers. We will first look at different age groups by binning the ages and calculating the acceptance rate for each group. We will then calculate the acceptance rate for different income levels and loan purposes.</p>
<div id="cell-22" class="cell" data-execution_count="312">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>bins <span class="op">=</span> [X_test[<span class="st">"person_age"</span>].<span class="bu">min</span>(), <span class="dv">25</span>, <span class="dv">35</span>, <span class="dv">45</span>, <span class="dv">55</span>, <span class="dv">65</span>, X_test[<span class="st">"person_age"</span>].<span class="bu">max</span>()]</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> [<span class="st">"&lt;25"</span>, <span class="st">"25-35"</span>, <span class="st">"35-45"</span>, <span class="st">"45-55"</span>, <span class="st">"55-65"</span>, <span class="st">"65+"</span>]</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>X_test[<span class="st">"age_group"</span>] <span class="op">=</span> pd.cut(X_test[<span class="st">"person_age"</span>], bins<span class="op">=</span>bins, labels<span class="op">=</span>labels, include_lowest<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>acceptance_rates_age <span class="op">=</span> X_test.groupby(<span class="st">"age_group"</span>).<span class="bu">apply</span>(<span class="kw">lambda</span> group: np.mean(preds[group.index] <span class="op">==</span> <span class="dv">0</span>))</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>sns.barplot(x<span class="op">=</span>acceptance_rates_age.index, y<span class="op">=</span>acceptance_rates_age.values, palette<span class="op">=</span><span class="st">"Blues_r"</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Age Group"</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Acceptance Rate"</span>)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Acceptance Rates by Age"</span>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>plt.ylim(<span class="fl">0.75</span>, <span class="dv">1</span>)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>plt.grid(axis<span class="op">=</span><span class="st">"y"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As the plot above shows, the acceptance rate is a bell curve with people between 35 and 55 having the highest acceptance rate. This makes logical sense because younger people are less settled and thus more risky to lend to while death becomes a worry when lending to older people. People in the middle are more likely to have stable jobs and thus be able to pay back the loan.</p>
<div id="cell-24" class="cell" data-execution_count="314">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>X_test[<span class="st">"predict_default"</span>] <span class="op">=</span> preds</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>X_test[<span class="st">"loan_status"</span>] <span class="op">=</span> y_test</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>medical <span class="op">=</span> X_test.groupby(<span class="st">"loan_intent_MEDICAL"</span>)[[<span class="st">"predict_default"</span>, <span class="st">"loan_status"</span>]].mean().reset_index()</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>venture <span class="op">=</span> X_test.groupby(<span class="st">"loan_intent_VENTURE"</span>)[[<span class="st">"predict_default"</span>, <span class="st">"loan_status"</span>]].mean().reset_index()</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>education <span class="op">=</span> X_test.groupby(<span class="st">"loan_intent_EDUCATION"</span>)[[<span class="st">"predict_default"</span>, <span class="st">"loan_status"</span>]].mean().reset_index()</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>medical <span class="op">=</span> medical.rename(columns<span class="op">=</span>{<span class="st">"loan_intent_MEDICAL"</span>: <span class="st">"Medical"</span>, <span class="st">"predict_default"</span>: <span class="st">"Predicted Default Rate"</span>, <span class="st">"loan_status"</span>: <span class="st">"Actual Default Rate"</span>})</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>venture <span class="op">=</span> venture.rename(columns<span class="op">=</span>{<span class="st">"loan_intent_VENTURE"</span>: <span class="st">"Business Venture"</span>, <span class="st">"predict_default"</span>: <span class="st">"Predicted Default Rate"</span>, <span class="st">"loan_status"</span>: <span class="st">"Actual Default Rate"</span>})</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>education <span class="op">=</span> education.rename(columns<span class="op">=</span>{<span class="st">"loan_intent_EDUCATION"</span>: <span class="st">"Education"</span>, <span class="st">"predict_default"</span>: <span class="st">"Predicted Default Rate"</span>, <span class="st">"loan_status"</span>: <span class="st">"Actual Default Rate"</span>})</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>display(medical, venture, education)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Medical</th>
<th data-quarto-table-cell-role="th">Predicted Default Rate</th>
<th data-quarto-table-cell-role="th">Actual Default Rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>False</td>
<td>0.086518</td>
<td>0.208673</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>True</td>
<td>0.103448</td>
<td>0.284250</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Business Venture</th>
<th data-quarto-table-cell-role="th">Predicted Default Rate</th>
<th data-quarto-table-cell-role="th">Actual Default Rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>False</td>
<td>0.091252</td>
<td>0.238305</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>True</td>
<td>0.081950</td>
<td>0.146266</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Education</th>
<th data-quarto-table-cell-role="th">Predicted Default Rate</th>
<th data-quarto-table-cell-role="th">Actual Default Rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>False</td>
<td>0.093304</td>
<td>0.237102</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>True</td>
<td>0.075680</td>
<td>0.167517</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Looking at the default predictions by loan intent and comparing them with the actual outcome is also interesting. The predicted default rate for medical intended loans is higher than other loans, and the actual default rate reflects this trend as well. This makes sense because medical loans are often taken out of necessity rather than choice so the individuals involved donâ€™t have the luxury to consider whether or not they will be able to pay them back. Loans for business ventures and education, on the other hand, have a lower predicted default rate and this is reflected in the actual default rate as well. This is likely because these loans are taken out with the intention of making money in the future, so if that comes to pass these individuals will be able to repay their loans more easily.</p>
<div id="cell-26" class="cell" data-execution_count="315">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>quartiles, bin_edges <span class="op">=</span> pd.qcut(X_test[<span class="st">"person_income"</span>], q<span class="op">=</span><span class="dv">6</span>, retbins<span class="op">=</span><span class="va">True</span>, labels<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> [<span class="ss">f"$</span><span class="sc">{</span><span class="bu">int</span>(bin_edges[i])<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span><span class="bu">int</span>(bin_edges[i<span class="op">+</span><span class="dv">1</span>])<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(bin_edges)<span class="op">-</span><span class="dv">1</span>)]</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>labels[<span class="dv">0</span>] <span class="op">=</span> <span class="ss">f"&lt;$</span><span class="sc">{</span><span class="bu">int</span>(bin_edges[<span class="dv">1</span>])<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>labels[<span class="op">-</span><span class="dv">1</span>] <span class="op">=</span> <span class="ss">f"&gt;$</span><span class="sc">{</span><span class="bu">int</span>(bin_edges[<span class="op">-</span><span class="dv">2</span>])<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>X_test[<span class="st">"income_group"</span>] <span class="op">=</span> pd.qcut(X_test[<span class="st">"person_income"</span>], q<span class="op">=</span><span class="dv">6</span>, labels<span class="op">=</span>labels)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>acceptance_rates_income <span class="op">=</span> X_test.groupby(<span class="st">"income_group"</span>).<span class="bu">apply</span>(<span class="kw">lambda</span> group: np.mean(preds[group.index] <span class="op">==</span> <span class="dv">0</span>))</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>sns.barplot(x<span class="op">=</span>acceptance_rates_income.index, y<span class="op">=</span>acceptance_rates_income.values, palette<span class="op">=</span><span class="st">"Blues_r"</span>)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Income Group"</span>)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Acceptance Rate"</span>)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Acceptance Rates by Income Level"</span>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>plt.ylim(<span class="fl">0.75</span>, <span class="dv">1</span>)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>plt.grid(axis<span class="op">=</span><span class="st">"y"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Finally, we will look at acceptance rates by income level. As the chart above shows, this is a pretty linear relationship with higher income individuals being more likely to be accepted for a loan. This makes sense because people with more money have more money with which to pay back the loan.</p>
</section>
<section id="discussion" class="level1">
<h1>Discussion</h1>
<p>The primary results are that, by using <strong>loan percent of income</strong>, <strong>person home ownership: rent</strong>, and <strong>loan intent: home improvement</strong> as predictor variables and a threshold of <strong>3.66</strong>, with a Logistic Regression model, a bank can expect to make around <strong>$1,400</strong> profit per borrower. Looking at these results, a few conclusions immediately jump to mind. First, for banks, the model would be very beneficial as it is more efficient than determining loans manually and allows them to maximize profit which is their goal. For borrowers, however, this model has the potential to be problematic. As with any data driven decision making process, data has the potential to lose important context and nuances about the individuals involved. For example, the model may be biased against certain groups of borrowers because the historical data that it was trained on was also biased. This has the potential to create a self perpetuating cycle where certain groups are always disadvantaged. This drawback must be weighed when considering the implementation of such a model.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>